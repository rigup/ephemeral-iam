# Security Considerations

## Service Account Token Generation Permissions
Ephemeral IAM is built around the idea that a user (User1) with the `iam.serviceAccounts.getAccessToken`
permission bound to a service account (SA1) is able to generate OAuth 2.0 tokens for
that service account using the `projects.serviceAccounts.generateAccessToken` method.

When using the `eiam` CLI, OAuth 2.0 tokens are generated with reduced session
duration of 10 minutes and the tokens are never written to persistent storage;
however, Ephemeral IAM does not attempt to stop users from using the
`projects.serviceAccounts.generateAccessToken` method outside of the context
of the `eiam` CLI. This means that any user could use the `iam.serviceAccounts.getAccessToken`
permission granted to them to get an OAuth 2.0 session token by requesting
one directly from the GCP IAM Credentials API.

### Adding Observability
For the reason outlined above, it is a good idea to add some observability
mechanisms around the generation of service account tokens, and Ephemeral IAM
provides some features to facilitate this. Any audit logs generated by requests
used within the context of the `eiam` CLI will include a `reason` attribute in the
`protoPayload.requestMetadata.requestAttributes.reason` field.  This field is
in the format `ephemeral-iam [a-f0-9]{16}: <USER_PROVIDED_REASON>`.

This can be leveraged to export audit logs and create alerts. An example Stackdriver
logging sink that exports all audit log entries generated by the `GenerateAccessToken`
method that do not have a properly formatted `reason` field is shown below.

**Log Export Filter:**
```
protoPayload.methodName="GenerateAccessToken"
AND protoPayload.requestMetadata.requestAttributes.reason !~ "ephemeral-iam [a-f0-9]{16}: .*"
```

These logs could be sent to a Cloud Pub/Sub to trigger alerts when someone
requests to generate a service account access token outside of the `eiam` CLI.

## Kubernetes Config Persistence
When a user authenticates to a Kubernetes cluster while impersonating a service
account, a new `.kubeconfig` entry is created with the associated credentials.

**Example:**
```
$ eiam gcloud container clusters get-credentials example-cluster \
    -s example@serviceaccount.com -r 'example reason'
```

Since this new entry is stored to the user's kubeconfig, the access that it
provides will persist past the duration of the `eiam` session (which in this case
is a single command).